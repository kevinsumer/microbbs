<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity4"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="site/layout">
<head>
  <title th:inline="text">[[#{app.title}]]</title>
  <meta name="ctx" th:content="${#httpServletRequest.getContextPath()}" />
  <link rel="stylesheet" th:href="@{/static/lib/editor/editor.css}" />
  <style type="text/css">
    .box-do-comments .CodeMirror {
      height: 114px;
    }

  </style>
</head>
<body>
<!--post header-->
<section layout:fragment="top" class="post-header">
</section><!--/post-->

<!--content-->
<main layout:fragment="content" id="posts">
  <section class="sidebar box box-primary">
    <div class="box-header with-border">
      <h3 class="post-title text-lg"  th:utext="${post.title}">title</h3>
      <i class="iconfont icon-zhiding icon-micro"
         th:if="${#bools.isTrue(post.top) and not #strings.equals(actived,'perfect') and not #strings.equals(actived,'now') }" title="置顶"></i>
      <i class="iconfont icon-youxuan icon-micro" th:if="${post.perfect}" title="优选"></i>
      <div class="post-footer">
        <a class="tag tag-sm" th:href="@{'/category/' + ${t.categoryId} + '/tag/' + ${t.id}}"
           th:each="t: ${post.tags}" th:utext="${t.title}">Tag</a>
        <span class="post-author">
          <a th:href="@{'/users/' + ${post.author.id} + '/profile'}" th:utext="${post.author.nick}">user</a> 发布于
        </span>
        <span class="post-time" th:utext='${#dates.format(post.createdTime, "yyyy-MM-dd HH:ss:mm")}'>1天前</span>
        <span class="post-author-last">最后由 <a href="#" th:utext="${post.lastAuthorName}">小明</a> 回复于</span>
        <span class="post-time-last" th:utext='${#dates.format(post.lastReplyTime, "yyyy-MM-dd HH:ss:mm")}'>1小时前</span>
        <span class="post-read-count"><span th:text="${post.readCount + 1}">A</span> 次阅读</span>
      </div>
    </div>
    <div class="box-body post-content" th:utext="${post.content}">
      content
    </div>

    <div class="box-footer">
      <button type="button" class="btn btn-default btn-xs"><i class="fa fa-share"></i> 分享</button>
      <button type="button" class="btn btn-default btn-xs"><i class="fa fa-bookmark"></i> 收藏</button>
      <a href="#do-comments" type="button" class="btn btn-default btn-xs pull-right"><i class="fa fa-reply"></i> 回复</a>
    </div>
  </section>

  <!--<section class="sidebar box box-danger">
    <div class="box-header with-border">
      <h3 class="box-title">热门回帖</h3>
      <div class="post-footer">
      </div>
    </div>
  </section>-->

  <section class="box box-default" id="comments">
    <div class="box-header with-border">
      <h3 class="box-title"><span th:text="${post.replyCount}"></span> 次回帖</h3>
    </div>

    <div class="box-footer box-comments">
      <template v-for="comment in comments">
        <div class="box-comment" :id="'floor' + comment.floor">
          <!-- User image -->
          <img class="img-circle img-sm" th:src="@{/static/lib/admin-lte/dist/img/user3-128x128.jpg}" alt="User Image">
          <div class="comment-text">
            <div class="username">
              {{comment.author.nick}}
              <a class="text-muted floor" :href="'#floor' + comment.floor"> # {{comment.floor}}</a>
              <span class="text-muted time"><i class="fa fa-clock-o"></i> {{comment.createdTime | moment}}</span>
              <a class="pull-right comment-action action-down" title="收藏"><i class="fa fa-bookmark"></i></a>
              <a class="pull-right comment-action action-like" title="反对"><i class="fa fa-thumbs-o-down"></i></a>
              <a class="pull-right comment-action action-up" title="赞同"><i class="fa fa-thumbs-o-up"></i></a>
              <a href="#do-comments" class="pull-right comment-action action-reply" title="回复此楼"><i class="fa fa-reply"></i></a>
            </div><!-- /.username -->
            <p>{{comment.content}}</p>
          </div>
          <!-- /.comment-text -->
        </div>
      </template>
    </div>
  </section>

  <section class="box box-default box-do-comments" id="do-comments">
    <div class="box-header with-border">
      <h3 class="box-title">发表回复</h3>
    </div>
    <!-- /.box-footer -->
    <div class="box-footer">
      <form action="#" method="post">
        <img class="img-responsive img-circle img-sm" th:src="@{/static/lib/admin-lte/dist/img/user3-128x128.jpg}" alt="Alt Text">
        <!-- .img-push is used to add margin to elements next to floating images -->
        <div class="img-push">
          <div class="form-group">
            <textarea name="reply-content" id="reply-content" rows="3" class="form-control" placeholder="在此输入回复内容，支持Markdown语法哦~"></textarea>
          </div>
          <button type="button" onclick="" class="btn btn-info btn-sm btn-flat">提交回复</button>
        </div>
      </form>
    </div>
  </section>
</main><!--/content-->

<aside class="col-xs-12 col-md-3" layout:fragment="sidebar">

  <section class="sidebar box box-widget widget-user">
    <!-- Add the bg color to the header using any of the bg-* classes -->
    <div class="widget-user-header bg-aqua-active text-center">
      <h3 class="widget-user-username" th:utext="${post.author.nick}">author</h3>
      <h5 class="widget-user-desc" th:utext="${post.author.info}">我的愿望是，世界和平</h5>
    </div>
    <div class="widget-user-image">
      <img th:src="@{/static/lib/admin-lte/dist/img/user2-160x160.jpg}" class="img-circle"
           alt="User Image">
    </div>
    <div class="box-footer">
      <div class="row">
        <div class="col-sm-4 border-right">
          <div class="description-block">
            <h5 class="description-header">3,200</h5>
            <span class="description-text">话题</span>
          </div>
          <!-- /.description-block -->
        </div>
        <!-- /.col -->
        <div class="col-sm-4 border-right">
          <div class="description-block">
            <h5 class="description-header">13,000</h5>
            <span class="description-text">回复</span>
          </div>
          <!-- /.description-block -->
        </div>
        <!-- /.col -->
        <div class="col-sm-4">
          <div class="description-block">
            <h5 class="description-header">35</h5>
            <span class="description-text">关注</span>
          </div>
          <!-- /.description-block -->
        </div>
        <!-- /.col -->
      </div>
      <!-- /.row -->
    </div>
  </section>


  <!--相关话题-->
  <section class="sidebar box box-success">
    <div class="box-header with-border">
      <h3 class="box-title">相关话题</h3>
    </div>
    <div class="box-body no-padding">
      <ul class="list">
        <li class="item"><a href="#">A</a></li>
        <li class="item"><a href="#">B</a></li>
        <li class="item"><a href="#">C</a></li>
      </ul>
    </div>
  </section><!--/相关话题-->

  <!--此刻-->
  <section class="sidebar box box-info">
    <div class="box-header with-border">
      <h3 class="box-title">此刻</h3>
    </div>
    <div class="box-body no-padding">
      <ul class="list">
        <li class="item"><a href="#">A</a></li>
        <li class="item"><a href="#">B</a></li>
        <li class="item"><a href="#">C</a></li>
      </ul>
    </div>
  </section><!--/此刻-->

</aside>

<div layout:fragment="scripts">
  <script type="text/javascript" src="//cdn.bootcss.com/layer/2.4/layer.min.js"></script>
  <script type="text/javascript" th:src="@{/static/lib/webuploader/webuploader.withoutimage.js}"></script>
  <!--<script src="//cdn.bootcss.com/markdown-it/8.1.0/markdown-it.min.js"></script>-->
  <script type="text/javascript" src="//cdn.bootcss.com/markdown-it/3.0.3/markdown-it.min.js"></script>
  <script type="text/javascript" th:src="@{/static/lib/editor/editor.js}"></script>
  <script type="text/javascript" th:src="@{/static/lib/editor/ext.js}"></script>
  <script src="//cdn.bootcss.com/moment.js/2.15.2/moment-with-locales.min.js"></script>
  <script src="//cdn.jsdelivr.net/vue.resource/1.0.3/vue-resource.min.js"></script>
  <script th:inline="javascript" type="text/javascript">
    $(function () {
      var editor = new Editor({element: $("#reply-content")[0], status: []});
      editor.render();

      var _ctx = $("meta[name='ctx']").attr("content");
      var postId = /*[[${post.id}]]*/;
      var commentsApp = new Vue({
        el: '#comments',
        data: {
          comments: null,
          totalComments: 0,
          totalPages: 0
        },
        created: function () {
           this.loadComments();
        },
        filters: {
          moment: function (date) {
            return moment(date).format('YYYY-MM-DD HH:mm');
          }
        },
        methods: {
          loadComments: function () {
            this.$http.get(_ctx + '/api/posts/' + postId + '/replies').then((response) => {
              // success callback
              if(response.status == 200 && response.ok) {
                this.comments =  response.body.content;
                this.totalComments = response.body.totalComments;
                this.totalPages = response.body.totalPages;
              }

            }, (response) => {
              // error callback
              console.log(response);
            });
          }
        }
      });
    });
  </script>
</div>
</body>
</html>
